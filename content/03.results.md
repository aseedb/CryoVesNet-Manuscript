## Results

In view of the effort required for the manual segmentation of SVs, we decided to develop an automatic segmentation procedure.
Since we had previously manually segmented a number of tomograms with the program IMOD, we could use these segmentations as the ground truth [@doi:10.1006/jsbi.1996.0013].
We trained a U-Net with a set of 9 segmented tomograms of rat synaptosomes (see Materials and Methods).
The learning progress was tracked by calculating the Dice coefficient and the loss value after each training epoch (Figure {@fig:dice}).
The Dice coefficient for the training set was initially ~0.25 and rose to over 0.9 after approximately 50 epochs, while for the validation set, it rose to 0.8. 
The loss for the training set went from 0.55 and to values below 0.05 after 50 epochs while for the validation set it went from 1 and to slightly below 0.3 after the initial 50 epochs and then rose slightly.

![**Dice coefficient and loss value for training and validation set.** ](images/traindice.png){#fig:dice width="7cm"}

We seeked to further improve segmentation accuracy by feeding the probability mask output by the U-Net to a series of postprocess steps (Figure {@fig:pipeline}).
Three sets of tomograms were used to assess the performances of the pipeline: 1) Traning dataset : The 9 rat synaptosome tomograms that had been used for U-Net training, 2) Testing dataset: Another 9 rat synaptosome tomograms, 3) Testing dataset for generizibility: 12 mouse primary neuronal culture tomograms). 

![**Pipeline of automatic segmentation.** a) tomograms b) splitting in 3D patches c) Segmentation Network/ trained U-Net d) probability masks e) stitching patches back together f) thresholding g) adaptive localized thresholding h) outlier removal i) radial profile](images/workflow.png){#fig:pipeline width="15cm"}

Each tomogram was split into patches of 32^3^ voxels.
These patches were fed in the U-Net, which output a probability mask for those patches.
To obtain a complete probability mask, the patches are stitched back together.
The probability mask was binarized first with a global threshold value and then with an adaptative localized thresholding steps (Figure {@fig:pipeline}, Figure {@fig:tom}).

![**A 2D slice of an automatically segmented dataset**. A) A section through a presynaptic terminal in a neuron tomogram. B) Predicted probability mask restricted to the segmentation region.  Purple corresponds to a low SV probability and yellow to a high SV probability. C) Instance mask of the vesicles after post processing.](images/tomo-sclae.svg){#fig:tom width="15cm"}

`\_more detail about global and adaptive localized threshold*`{.green}
For further optimization of the mask, outliers were removed. 
Removed outliers mostly consisted of vesicles which were only partially segmented, and vesicles which maks were adjacent due to proximity.
The removed masks, which only partially traced the vesicles, were reevaluated by reducing or expanding their radius (Figure {@fig:radial_profile}).
`\_was the center of the vesicles also reevaluated?*`{.green} `\_Its not clear or might be false sentence we didnt remove or re evaluate the mask?*`{.green}

![**Vesicle radius and position through radial profile and cross-correlation** Radial Profile Refinement A) couple of vesicles are not centered B) Radial Profile. Blue range is from membrane center to outer white halo center, this is the search range for the optimal radius. (smoothed by gaussian filtering) C) second derivative of radial profile E, F, H, G) Same as above columns after refinement](images/radial_avg_115-099.svg){#fig:radial_profile width="15cm"}

The adjacent vesicle masks were seperated (Figure `\_missing*`{.green}). `\_how?*`{.green}

`\_**missing Figure- Splitting adjacent vesicles. A) Examples of tomogram, no labels; B) raw label with connected vesicle-labels; C) modified label with seperated vesicles ---> for software: IMOD**`{.green}

The Dice coefficient was used to track the global congruence between the manually segmented mask and the predicted mask within the different tomograms (Figure {@fig:dice-improv}).

![**Dice developement during post-processing** Dice developement at different post processing steps of initial predicted mask (different colors correspond to different tomograms): A) synaptosomal training datasets B) synaptosomal test datasets c) neuron test datasets](images/improvment-post-processing-dice.svg){#fig:dice-improv width="15cm"}

![**Synaptosome.** ](images/synaptosome.png){#fig:dice width="7cm"}

| **_Dataset_**  | **_Mask Dice_** | **_Final Label Dice_** | **_δ d_** | **_Δ c (nm)_** | **_Number of Vesicles_**  | **_TP_**   | **_FN_**   | **_FP_**  |
| -------------- | :-------------: | :--------------------: | :-------: | :------------: |:-------------------------:|:----------:|:----------:|:---------:|
| Synaptosome C1 |      0.44       |          0.73          |   0.07    |   2.55±1.56    |            223            |    198     |     26     |    49     |
| Synaptosome C2 |       0.8       |          0.9           |   0.05    |   2.12±1.06    |            105            |    103     |     2      |     1     |
| Synaptosome C3 |      0.67       |          0.9           |   0.05    |   1.86±1.24    |            128            |    127     |     1      |     6     |
| Synaptosome C4 |      0.62       |          0.89          |   0.03    |   1.78±0.92    |            144            |    141     |     3      |     4     |
| Synaptosome C5 |      0.58       |          0.87          |   0.04    |   1.86±1.00    |            214            |    209     |     5      |    13     |
| Synaptosome C6 |      0.56       |          0.84          |   0.04    |   1.92±1.05    |            104            |    102     |     2      |    16     |
| Synaptosome C7 |      0.78       |          0.88          |   0.06    |   1.86±0.90    |            184            |    184     |     0      |    16     |
| Synaptosome C8 |      0.75       |          0.9           |   0.05    |   1.70±0.93    |            132            |    126     |     6      |     1     |
| Synaptosome C9 |      0.59       |          0.87          |   0.05    |   1.87±0.91    |            135            |    132     |     3      |    14     |
| **Average**    |  **0.64±0.11**  |     **0.86±0.05**      | **0.05**  | **1.95±1.08**  |        **152.22**         | **97.00%** | **3.00%**  | **7.30%** |
Table: Evaluation of the segmentation on the synaptosome train set. Mask Dice: Mask Dice coefficient for the predicted mask; Final Label Dice: Dice coefficient after post-processing; δ d: diameter error on correctly detected vesicle; Δ c: average error center (nm); Number of Vesicles: number of expected vesicles; TP: True Positive; FN: False Negative; FP: False Positive
{#tbl:train-tomograms}


| **_Dataset_**   | **_Mask Dice_** | **_Final Label Dice_** | **_δ d_** | **_Δ c (nm)_** | **_Number of Vesicles_** |  **_TP_**  | **_FN_**  | **_FP_**  |
| --------------- |:---------------:|:----------------------:| :-------: | :------------: |:------------------------:|:----------:|:---------:|:---------:|
| Synaptosome C10 |      0.75       |          0.88          |   0.07    |   1.86±1.18    |           129            |    123     |     6     |     5     |
| Synaptosome T1  |      0.75       |          0.83          |   0.11    |   2.66±1.52    |           699            |    687     |    12     |    33     |
| Synaptosome T2  |      0.74       |          0.77          |   0.11    |   2.27±1.84    |           122            |    117     |     5     |     2     |
| Synaptosome T3  |      0.72       |          0.74          |   0.11    |   3.64±2.22    |           434            |    397     |    37     |    57     |
| Synaptosome T5  |      0.77       |          0.85          |   0.08    |   2.20±1.26    |           535            |    526     |     9     |    25     |
| Synaptosome T6  |       0.6       |          0.83          |   0.07    |   2.02±1.12    |           373            |    353     |    20     |    42     |
| Synaptosome T7  |       0.8       |          0.83          |   0.06    |   2.22±1.14    |           110            |    107     |     3     |     9     |
| Synaptosome T8  |      0.83       |          0.91          |   0.04    |   2.09±1.04    |           100            |     99     |     1     |     2     |
| Synaptosome T10 |      0.77       |          0.86          |   0.05    |   1.96±1.04    |            77            |     74     |     3     |     6     |
| **Average**     |  **0.75±0.06**  |     **0.83±0.05**      | **0.08**  | **2.32±1.43**  |        **286.56**        | **96.30%** | **3.70%** | **6.10%** |
Table: Evaluation of the segmentation on the synaptosome test set (same sample type as the train set). For the meaning of the columns, see Table @tbl:train-tomograms.
{#tbl:test-tomograms}

| **_Dataset_** | **_Mask Dice_** | **_Final Label Dice_** | **_δ d_** | **_Δ c (nm)_** | **_Number of Vesicles_** |  **_TP_**  |  **_FN_**  | **_FP_**  |
| ------------- |:---------------:|:----------------------:| :-------: | :------------: |:------------------------:|:----------:|:----------:|:---------:|
| Neuron 133    |      0.76       |          0.86          |   0.05    |   2.16±1.32    |           523            |    467     |     56     |     8     |
| Neuron 123    |      0.64       |          0.71          |   0.05    |   2.05±1.18    |            66            |     58     |     8      |     2     |
| Neuron 84     |      0.86       |          0.89          |   0.06    |   1.44±0.75    |           498            |    484     |     14     |     1     |
| Neuron 134    |      0.56       |          0.67          |   0.09    |   2.87±2.50    |           638            |    384     |    254     |    63     |
| Neuron 115    |      0.57       |          0.63          |   0.08    |   3.56±3.23    |           170            |    123     |     47     |    32     |
| Neuron 102    |      0.73       |          0.86          |   0.05    |   1.47±0.79    |           103            |     86     |     17     |     1     |
| Neuron 80     |       0.7       |          0.81          |   0.07    |   2.67±2.00    |           111            |    102     |     9      |     3     |
| Neuron 114    |      0.65       |          0.73          |   0.07    |   2.68±1.79    |           131            |     93     |     38     |     9     |
| Neuron 132    |      0.69       |          0.87          |   0.03    |   1.65±1.26    |           135            |    129     |     6      |    32     |
| Neuron 73     |      0.78       |          0.83          |   0.06    |   2.93±2.00    |           526            |    483     |     43     |     2     |
| Neuron 128    |      0.67       |          0.85          |   0.04    |   2.33±1.70    |           252            |    232     |     20     |    19     |
| Neuron 116    |      0.62       |          0.73          |   0.07    |   2.38±1.82    |           296            |    207     |     89     |    35     |
| **Average**   |  **0.69±0.09**  |     **0.79±0.09**      | **0.06**  | **2.35±1.83**  |        **287.42**        | **83.60%** | **16.40%** | **7.90%** |
Table: Evaluation of the segmentation on the neuron test set (different sample type as the train set). For the meaning of the columns, see Table @tbl:train-tomograms.
{#tbl:neuron-tomograms}

Our method transfers well across datasets even without fine-tuning which shows robustness and generalization.

### Comparison of manual segmentation with automatic deep-learning based segmentation

![**3D model of manual segmented and automatically segmented synaptosome.**](images/3d.png){#fig:3d width="10cm"}


###  Hierarchical connectivity segmentation of presynaptic terminals
Pyto is a software package designed for the analysis of pleomorphic membrane-bound molecular complexes in 3D images, particularly in the context of cryo-electron tomograms of neuronal synapses. A key feature of Pyto is its ability to accurately segment connectors and tethers within the pre-synaptic terminal, a task that requires a high level of precision. This segmentation process is hierarchical and connectivity-based, detecting densities interconnecting vesicles (connectors) and densities connecting vesicles to the active-zone plasma membrane (tethers).

In the study of synaptic vesicles regulation, the precision of segmentation is crucial. Accurate segmentation of connectors and tethers is essential as these structures play a significant role in the regulation of synaptic vesicles. Software that segments subcellular compartments, such as Pyto, provides a valuable tool in this process.

We have developed a software that is designed to be compatible with programs like Pyto. This compatibility allows us to extract more detailed information from Cryo-Electron Tomography (Cryo-ET), even in densely populated in situ conditions. By using our software in conjunction with programs like Pyto, we can gain a deeper understanding of synaptic vesicles regulation. Importantly, our software aims to eliminate the need for manual segmentation, enhancing the efficiency and accuracy of the process.

![**3D model of manual segmented and automatically segmented synaptosome.**](images/amira_all.png){#fig:3d width="10cm"}
