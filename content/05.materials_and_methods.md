## Materials and methods

### Cryo-electron Tomography Datasets

Two datasets of different origin were used as input and test subjects for the automatic segmentation pipeline, respectively.
They consisted in rat synaptosomes primary neuron cultures derived from mice.
The preparation procedure of the samples from which the datasets were obtained as well as the biological analysis of these datasets was previously reported.  [@doi:10.1101/2022.03.07.483217].

Synaptosome preparation

Preparation of astrocytic and neuronal culture

Plunge freezing and spray mixing (Vitrification)

Cryo-electron microscopy (Cryo-ET)

Tomogram reconstruction

Ground truth annotation for organelles, cytoplasm, and membranes

Ground truth vesicles annotation

CNN Preproscessing

Biniarization of probability masks

Post Processing on Biniraized map (adaptive threeshold, radial profile, outlier removal)

Evaluation metrics

Computational setup




### Manual segmentation and automatic interboundary segment detection

Manual segmentation of SVs, mitochondria, the active zone PM, and of the segmentation region was done in IMOD (???Figure S4A&B???) [@10.1006/jsbi.1996.0013]. SVs were segmented as spheres.
The segmentation region marked the region to be analyzed by Pyto [@doi:10.1016/j.jsb.2016.10.004].
The analysis by Pyto was essentially the same as described previously [@doi:10.1083/jcb.200908082; @doi:10.1016/j.jsb.2016.10.004].
In short, the segmented region is divided in 1 voxel thick layers parallel to the active zone for distance calculations.
A hierarchical connectivity segmentation detects densities interconnecting boundaries.
The boundaries were synaptic vesicles and the active zone PM. Detected intervesicular segments are termed connectors and segments connecting vesicles to the active zone PM are called tethers (Figure `\_add figure number*`{.green}).
Distance calculations respective to SVs were done from SV center.
The segmentation procedure is conservative and tends to miss some tethers and connectors because of noise.
Consequently, the numbers of tethers and connectors should not be considered as absolute values, but rather to compare experimental groups.
As it was done before, an upper limit was set between 2100 and 3200 nm^3^ on segment volume.
The tomograms that were used for this analysis were binned by a factor of 2 to 3, resulting in voxel sizes between 2.1 and 2.4 nm.

### Pre-processing of manual segmentation outputs from IMOD for further use (jupyter notebook pre-pyto)
`probably not necessary to mention output from IMOD to prepyto input label file procedure`

`put this somewhere else`{.green}


### Dataset description
The used datasets included a total of 30 tomograms with heterogeneous pixel sizes, defocus and resolution. 

1. 9 synaptosome datasets were used for training and validation.
2. 9 synaptosome datasets was used for test.
3. 12 Neuron dataset were used for assessing transfer learning potential.

### Training Dataset Construction
In the preparation of our training dataset, we utilized segmented 3D image volumes.
The primary volume was systematically divided into 32x32x32 sub-volumes.
To ensure the relevance and richness of the data, only those sub-volumes that were sufficiently occupied by vesicles, specifically containing more than 1000 voxels, were retained.
This meticulous approach was adopted to ensure that the training set effectively captured the intricate cellular structures, optimizing it for subsequent deep learning analyses.


### Stiching Patches Back Together (building probability map?)

In deep learning segmentation for cryoET tomograms, smaller patches are segmented for computational efficiency.
Our U-Net model, trained on 32-voxel patches, utilizes a 24-voxel region of interest (ROI).
To mitigate tiling effects during testing, the network input can be expanded to larger volume like 64 voxels.
The tomogram undergoes padding to align with the ROI, ensuring reduced edge artifacts.
Segmentation is executed in tiles, where the U-Net predicts the synaptic vesicle probability for each tile.
Only the central part of the segmented patch, corresponding to the ROI, is retained.
This approach guarantees consistency in overlapping regions between adjacent tiles.
Finally, the segmented tiles are reassembled, yielding a continuous synaptic vesicle probability map of the entire volume.


### Network architecture and training procedure

We used a U-Net with two downsampling stages and two convolutional layers per stages, with a kernel size of 3, and ReLU activation function based on the open-source CARE framework (Figure {@fig:unet}) [@doi:10.1038/s41592-018-0216-7]. 
Datasets were prepared by splitting the 3D tomographic volume of synaptosomes into 32^3^-voxel subvolumes and keeping only subvolumes occupied by a sufficient amount (> 1000 voxels) of binarized vesicle label.
860 subvolumes were used for training and 100 subvolumes were used for validation.
We used the Adam optimizer on a binary cross-entropy loss function.

The learning progress was tracked by calculating the Dice coefficient and the loss value after each training epoch (Figure {@fig:dice}).
The Dice coefficient for the training set was initially ~0.25 and rose to over 0.9 after approximately 50 epochs, while for the validation set, it rose to 0.8. 
The loss for the training set went from 0.55 and to values below 0.05 after 50 epochs while for the validation set it went from 1 and to slightly below 0.3 after the initial 50 epochs and then rose slightly.

![**Dice coefficient and loss value for training and validation set.** ](images/traindice.png){#fig:dice width="7cm"}


![**Network architecture used for vesicle segmentation.** We used a U-Net based on the CARE framework [@doi:10.1038/s41592-018-0216-7]. The input is a cubic volume of 32^3^ voxels. The output is a per-prix probabilty cube of the same size as the input. ](images/unet.png){#fig:unet width="10cm"}


### Global Threshold
In the pursuit of refining the output of our deep neural network, a systematic approach was employed to determine the optimal threshold for the probability mask.
The objective was to ascertain a threshold that minimizes the values at the vesicle borders, ensuring precise delineation.
By iterating through potential threshold values ranging from 0.8 to 1 in increments of 0.01, a binary mask was generated for each threshold.
Subsequently, an erosion operation was applied to the binary mask, and the difference between the original and eroded masks produced the vesicle shell. The pixel values of the original image corresponding to this shell were recorded for each threshold.
This iterative process aids in identifying the threshold that offers the sharpest and most accurate representation of vesicle borders.

### U-Net output threshold refinement

The probability mask output by the U-Net was first made binary by determining a global threshold value. To this end, the mask was binarized for a range of threshold values comprised between 0.8 and 1. For each probability value a 1-voxel thick label shell  was computed. 
The shell mask was then applied on the input data and the average masked voxel intensity was computed.
Since the shell of correctly segmented vesicles corresponds to the vesicle membrane, we expect low intensity pixels.
The threshold value resulting in the minimal average intensity of the shell masked voxels was used as the global threshold.  
`Amin please write the equations for these steps`{.green}.
The probability mask was binarized using the global threshold and was each separate segment was assigned an individual label with `scikit-image label` method.


A majority of vesicles were correctly segmented but we noticed some segments included two vesicles.
We therefore evaluated each segment with two criteria based on the fact that synaptic vesicles have a homogenous size and are spherical. 
Firstly we calculated the volume z-score $z$ for each segment:
$$z(S_i) = \frac{V(S_i) - \mu}{\sigma}$$ {#eq:z-score-volume}
where $S_i$ is the segment $i$, $V(S_i)$ is the volume of $S_i$, $\mu$ the average volume of all segments, and $\sigma$ the standard deviation of the segment volumes.
Secondly, we computed the segment extent $e$:
$$e(S_i) = \frac{V(S_i)}{B(S_i)}$$ {#eq:extent}
where $B(S_i)$ is the volume of segment $i$ bounding box.
The extent of a sphere equals $\frac{\pi}{6}$.
Segments with both a z-score $z > 1$ and an extent $e < 0.25$ were considered as potentially comprising two vesicles.
For each of these segments, the probability mask threshold was increased until two distinct segments were generated.
Subsequently, the extent and volume of all segments was evaluated again. Any segment with $e < 0.25$, or $e > 0.75$, or $V < k$ was discarded. 
This ensured that segments deviating highly from spherical shape and segments with a volume smaller than an acceptable volume $k$ were removed.

Even if most synaptic vesicles were detected and well segmented, segmentation accuracy was not sufficient for our downstream application.
To improve accuracy, each segment was converted to a spherical segment and its radius and position was refined.
Initial spherical conversion was done by setting the center of the sphere $C$ at the position of the centroid of the segment, while the radius $r$ was defined as half the length of the bounding box longest edge. 
The segment position and radius was iteratively refined as follows. 
1. The radial average $\langle I(d)\rangle$ was computed:
$$\langle I(d)\rangle = \frac{1}{4\pi ^2 r^2} \int_{0}^{2\pi}\int_{0}^{2\pi}I(d,\theta ,\phi) \, d\phi \, d\theta$$ {#eq:radial_average}
where $d$ is the radial distance from the segment center, $\theta$ the polar angle, and $\phi$ the azimuthal angle.
2. The radius of the vesicle $r$ was updated as:
$$r = d_m + \frac{t_m}{2}$$ {#eq:vesicle_radius}
where $d_m$ is the radial distance of center of the vesicle membrane, and $t_m$ the thickness of the vesicle membrane.
$d_m$ was defined as the radial distance for which the radial average was minimal.
$\frac{t_m}{2}$ was calculated as the distance between the center of the vesicle membrane and the minimum of the second derivative of the radial profile in the interval between the center of the vesicle membrane and the maximum of the Fresnel fringe outside the membrane.
3. The radial average was back projected in 3-dimension:
$$I(x,y,z) =  \langle I(\sqrt{x^2+y^2+z^2})\rangle$$ {#eq:3d-average}
where $(x,y,z)=(0,0,0)$ is the coordinate of the segment center.
4. We computed by cross-correlation the shift between the obtained 3-D average and the 3-D image in the cubic box with central coordinates $C$ and edge length $l = 2r + c$, where $c$ is a constant.
$C$ was updated by subtraction of the shift. 
5. Steps 1 to 4 were repeated for a maximum of 10 iterations until convergence or until a total shift of $\frac{1}{2}\sqrt{3l_o^2}$, where $l_o is the edge length of the initial box. 
The feature space of predicted vesicle labels was computed, containing membrane thickness $t_m$, membrane intensity $\rho$, and vesicle radius $r$.
$\rho$ was defined as the mean intensity of the radial average within the radial distance interval $[d_m - \frac{t_m}{2}\,,\,d_m + \frac{t_m}{2}]$.


///FROM THE OLD RESULTS
### Initial Segmentation and Thresholding

While a global threshold serves as an initial step in vesicle segmentation, it often falls short in complex scenarios, especially when vesicles are in close proximity or exhibit overlap. To enhance the segmentation accuracy in such cases, we employ an adaptive thresholding methodology that capitalizes on the probability mask generated by our deep learning architecture.

The segmentation journey commences with the alignment of the image with its associated deep labels and the probability mask. To ensure a comprehensive segmentation, the probability mask's edges are cropped, safeguarding against inadvertent truncation of boundary-residing vesicles. An optimal threshold, derived from the image and the probability mask, undergoes fine-tuning through a coefficient adjustment. This refined threshold then serves to binarize the mask, with connected components subsequently labeled, delineating individual vesicles.

### Collision Resolution through adaptive Thresholding
In scenarios where vesicles are densely packed, collisions become a challenge, often leading to the amalgamation of multiple vesicles into a singular segmented entity. Addressing this, potential collision vesicles are pinpointed based on specific geometric attributes, such as their extent and area z-score. For each vesicle identified under this criterion, a localized region surrounding the vesicle is extracted. This region is then subjected to a masking process, ensuring focus remains solely on the vesicle in question.

The essence of collision resolution revolves around the iterative modulation of the threshold to attain a more granular segmentation. Commencing from the established threshold, it's progressively augmented until the connected components within the localized region amplify, signaling a potential vesicle separation. This adaptive modulation persists until a threshold is identified that adeptly segregates the vesicles or until a set precision threshold is attained.

### Expansion and Removal of tiny Vesicles
Post-segmentation, certain vesicles might be represented as notably smaller than anticipated. To address this, an expansion strategy is employed, iteratively lowering the threshold to encapsulate more of the vesicle's structure. If expansion fails to achieve the desired size, these diminutive vesicles are removed, ensuring the final segmentation remains representative of genuine vesicle structures.
In conclusion, our adaptive thresholding technique, combined with collision resolution, ensures a more accurate and refined segmentation of vesicles in cryo-ET data. This approach capitalizes on the rich information present in the probability mask, providing a robust solution to the challenges posed by closely packed vesicles.
/// END FROM THE OLD RESULTS



### Outlier Detection and refinement

Based on the radial profile of the data, key features, namely thickness, radius, and membrane density, are extracted.
Using these criteria, the Mahalanobis Distance is calculated for each data point to quantify its distance from the distribution of these features.
The significance of the Mahalanobis Distance is interpreted using the chi-squared distribution.
The p-value is derived by employing the cumulative distribution function (CDF) of the chi-squared distribution, with the Mahalanobis Distance as the input and the length of the criteria as the degrees of freedom.
The resulting p-value provides a measure of the statistical significance of each data point's distance.

With the computed p-values, outlier detection and refinement are conducted.
If the p-value of a specific vesicle is not within an acceptable range (0.3), indicating it might be an outlier, its radial profile is recalculated using a broader margin to find the optimal profile.
We perform this recalculation for up to 10 iterations. Typically, vesicles are either adjusted within the initial iterations or remain unchanged throughout. Vesicles that, even after recalibration, do not meet the p-value criteria are entirely removed from the dataset
This iterative process, involving recalculating the radial profile and adjusting parameters, continues until all vesicles either conform to the acceptable p-value range or are excluded.
The refined dataset is then ready for subsequent analyses.
This iterative approach ensures that all vesicles in the dataset either meet the p-value criteria or are excluded.
Outlier detection and refinement are initiated based on the computed p-values.



Using this multivariate feature space, we detect outliers by computing Mahalanobis Distances (MD) on normalized variables using the covariance matrix of observation and obtaining the p-value on MD.

`The sphere segments with a p-value higher than a defined threshold were discarded and the process was repeated iteratively.
If the MD p-value of a specific vesicle was not in a specific margin range (0-10), their radial profile was recalculated, and the label entirely removed if they again failed to pass the margin of the p-value.`{.yellow}
`Amin, please check what exactly was done with the outliers. 
And p-value cannot be higher than 1, while you wrote (0-10)`{.green}

### Evaluation Metrics (Analysis of Results)

The evaluation framework was designed to assess the capabilities of the proposed toolbox for automatic synaptic vesicle segmentation.
The framework was not only designed to evaluate quantitatively performance of the neural network, but rather assay the segmentation of vesicles in practice `\_unsure what the last part means*`{.green}. `\_I tried to say we develop the software rather than an algorithm paper with ablation study kinda more trasnfer learning but however for tranfer learning we might need add finetunning the network or say this sentence in other way*`{.green}.
The pipeline also generates a specific output format, which is necessary to further analyze the presynaptic tomograms via another pre-developed toolbox (Pyto), which segments small molecular filaments associated to the synaptic vesicles, titled tethers and connectors.

#### DICE


The `\_general form??*`{.green} DICE coefficient for probabilistic subvolume maps was calculated after each epoch as a performance quantification while `\_during?*`{.green} training.
The probabilistic mask subvolumes were stitched back together, creating a probabilistic map of the whole tomogram. 
The Soft-DICE for the whole tomogram was calculated to evaluate the similarity of the predicted probability mask with ground truth. 
Note that soft-dice is equivalent to dice, when the input is binarized (which we will do at the end of the post-processing).


$$1-\frac{2\sum_{voxels} y_{true} y_{pred}}{\sum_{voxels} y_{true}^2+\sum_{voxels} y_{pred}^2}$$


`\_shouln't it be voxels instead of pixels??*`{.green}
`\_yes voxel is right*`{.green}
`\_fixed*`{.green}


THE DICE was also employed to monitor all stages of post-processing on the eventual label file, to observe the effect of each post-processing step.

#### Vesicle Diameter Deviation Analysis

Vesicle Diameter Deviation Analysis

A critical characteristic of a vesicle is its diameter, predetermined as per specific criteria (refer to the Outlier Exclusion section). To assess the precision of our diameter estimation for accurately identified vesicles, a deviation metric is introduced.

Denote the diameter of a manually segmented vesicle by $d_{GTi}$ and the estimated diameter of the corresponding vesicle as $d_{Si}$. The deviation in diameter estimation for each vesicle can be expressed as:

$$\delta d=1-\frac{min(dSi,dGTi)}{max(dSi,dGTi)}$$ {#eq:regular-equation}

This formula offers an insight into the congruence between our estimated diameter and the manual segmentation, with a diminished value of $\delta d$ signifying a closer approximation.


The diameter of a vesicle is one of its relevant characterizations, and it is predefined (see Outlier Removal). 
`\_which diameters are we using in this evaluation as input, pre- or post-outlier removal?*`{.green}
`\_after! I meant from that perentesis that radius or dimater we assume as one charectiristic of vesicle we might can write it better *`{.green}
The error of diameter estimation of true-detected vesicle is defined as 1 minus the proportion of diameters 

$$\delta d=1-\frac{min(dSi,dGTi)}{max(dSi,dGTi)}$$ {#eq:regular-equation}

where dGTi is the diameter of each true manual segmented vesicle, and dSi is the diameter of its estimation.

#### Center error

The center error is an euclidean distance of ground truth and corresponds to true predicted vesicles `\_true pos or true neg? True Predicted means true postive*`{.green}.
A vesicle was defined as a true-detected vesicle if the predicted center was located inside the hand-segmented vesicle or the other way around the center of prediction was located inside the predicted vesicle. 
`\_isn't this a bit too general, shouldn't this be a tighter evaluation?*`{.green}
`\_we assume this as hard condition to be true postive we could define like some % liek 50% intersection but this condition is generally harder`{.green}
This means the volume of intersection of the estimated vesicle with the distance of d to a ground truth vesicle with radius R is: 

$$V=\frac{1}{12}\pi(4R+d)(2R-d)$$



### Computational Setup
All experiments were conducted using 4 x NVIDIA 2080 Ti GPUs with CUDA 10.1.
`\_Ioan's Grant Acknowledgement*`{.green}
The software environment was set up with Python 3.
Key libraries and packages utilized include TensorFlow 2.4.1 with GPU support and Keras 2.4.3.
For visualization neurons with tethers and connectors and regarding video, Amira 2022.2 was employed.
Image visualizations were achieved using both UCSF Chimera and ChimeraX.
Surface rendering was performed by the volume tracer and color zone in UCSF ChimeraX.
For detailed configurations and parameters, users are referred to the accompanying source code.

### Manuscript preparation
The manuscript was written with the open and collaborative scientific writing package Manubot [@doi:10.1371/journal.pcbi.1007128]. 
The source code and data for this manuscript are available at <https://github.com/aseedb/synaptic_tomo_ms>.
